<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prast Tracker</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-bottom: 2px solid #22c55e;
            color: #16a34a;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Autocomplete styles */
        .autocomplete-items {
            position: absolute; border: 1px solid #d1d5db; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; background-color: white;
        }
        .autocomplete-items div {
            padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd;
        }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        .autocomplete-active { background-color: DodgerBlue !important; color: #ffffff; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 flex items-center justify-center">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg">
        <!-- Password Wall -->
        <div id="passwordWall" class="p-8 sm:p-12">
            <div class="flex flex-col items-center">
                <img src="logo.png" alt="Prast Farms Logo" class="h-24 w-24 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/22c55e/ffffff?text=PF';">
                <h1 class="text-3xl font-bold text-gray-800 mt-4">Prast Tracker</h1>
                <p class="text-gray-600 mt-2">Please enter the password to continue.</p>
            </div>
            <div class="mt-8 space-y-4">
                 <input type="password" id="password" class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center text-lg">
                 <button id="unlockBtn" class="w-full py-3 px-4 rounded-lg text-white bg-blue-600 hover:bg-blue-700 font-semibold text-lg">Unlock</button>
            </div>
        </div>

        <!-- Main App Content (hidden by default) -->
        <div id="appContent" class="hidden">
            <!-- Header -->
            <header class="flex flex-col items-center p-6 border-b">
                <img src="logo.png" alt="Prast Farms Logo" class="h-24 w-24 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/22c55e/ffffff?text=PF';">
                <h1 class="text-3xl font-bold text-gray-800 mt-4">Prast Tracker</h1>
            </header>

            <!-- Tabs -->
            <div class="flex border-b">
                <button id="addTabBtn" class="tab-button flex-1 py-4 text-lg font-semibold text-gray-600 hover:bg-gray-50 active">Add New Record</button>
                <button id="viewTabBtn" class="tab-button flex-1 py-4 text-lg font-semibold text-gray-600 hover:bg-gray-50">View & Search Records</button>
            </div>

            <main class="p-6 sm:p-8">
                <!-- Add New Record Section -->
                <section id="addRecordSection">
                    <form id="addRecordForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="type" class="block text-base font-medium text-gray-700 mb-1">Type</label>
                                <select id="type" class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="Farm Investment">Farm Investment</option>
                                    <option value="Real Estate">Real Estate</option>
                                </select>
                            </div>
                             <div class="relative">
                                <label for="firstName" class="block text-base font-medium text-gray-700 mb-1">First Name</label>
                                <input type="text" id="firstName" required autocomplete="off" class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Jane">
                            </div>
                            <div class="relative">
                                <label for="lastName" class="block text-base font-medium text-gray-700 mb-1">Last Name</label>
                                <input type="text" id="lastName" required autocomplete="off" class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., Doe">
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1">Investment Date</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="text" id="investDateDay" required class="w-1/4 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="DD" maxlength="2" inputmode="numeric">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="investDateMonth" required class="w-1/4 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="MM" maxlength="2" inputmode="numeric">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="investDateYear" required class="w-1/2 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="YYYY" maxlength="4" inputmode="numeric">
                                </div>
                            </div>
                            <div>
                                <label class="block text-base font-medium text-gray-700 mb-1">Due Date</label>
                                 <div class="flex items-center space-x-2 mt-1">
                                    <input type="text" id="dueDateDay" required class="w-1/4 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="DD" maxlength="2" inputmode="numeric">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dueDateMonth" required class="w-1/4 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="MM" maxlength="2" inputmode="numeric">
                                    <span class="text-gray-500">/</span>
                                    <input type="text" id="dueDateYear" required class="w-1/2 p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-center" placeholder="YYYY" maxlength="4" inputmode="numeric">
                                </div>
                            </div>
                            <div>
                                <label for="investSum" class="block text-base font-medium text-gray-700 mb-1">Investment Sum (₦)</label>
                                <input type="number" id="investSum" required class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., 500000">
                            </div>
                            <div>
                                <label for="dueSum" class="block text-base font-medium text-gray-700 mb-1">Due Sum (₦)</label>
                                <input type="number" id="dueSum" required class="mt-1 block w-full p-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., 550000">
                            </div>
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="w-full flex justify-center py-4 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Save Record
                            </button>
                        </div>
                    </form>
                </section>

                <!-- View & Search Section -->
                <section id="viewRecordSection" class="hidden">
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="searchInput" class="flex-grow p-3 border border-gray-300 rounded-lg" placeholder="Search by name, date, sum, etc...">
                        <select id="sortFilter" class="p-3 border border-gray-300 rounded-lg">
                            <option value="recent">Sort by Most Recent</option>
                            <option value="asc">Sort A-Z (by First Name)</option>
                            <option value="desc">Sort Z-A (by First Name)</option>
                        </select>
                    </div>
                    <div id="recordList" class="space-y-4">
                        <!-- Records will be loaded here -->
                    </div>
                </section>
            </main>
        </div>
        <!-- Status/Error Messages -->
        <div id="statusMessage" class="hidden p-4 m-8 rounded-lg text-center"></div>
    </div>

    <script>
        // Use the App ID you provided
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby901f9aG5P7dfL2aHYIRLEdOpZ4JSifJT-Kp3VoKBpa6FylRwId5bHia4ioKEO-bno/exec";

        // --- DOM Elements ---
        const passwordWall = document.getElementById('passwordWall');
        const appContent = document.getElementById('appContent');
        const unlockBtn = document.getElementById('unlockBtn');
        const passwordInput = document.getElementById('password');
        const addTabBtn = document.getElementById('addTabBtn');
        const viewTabBtn = document.getElementById('viewTabBtn');
        const addRecordSection = document.getElementById('addRecordSection');
        const viewRecordSection = document.getElementById('viewRecordSection');
        const addRecordForm = document.getElementById('addRecordForm');
        const statusMessage = document.getElementById('statusMessage');
        const recordList = document.getElementById('recordList');
        const searchInput = document.getElementById('searchInput');
        const sortFilter = document.getElementById('sortFilter');
        
        let allRecords = []; // To store fetched records
        let clientNames = []; // To store unique client names for autocomplete

        // --- Tab Switching ---
        addTabBtn.addEventListener('click', () => {
            addRecordSection.classList.remove('hidden');
            viewRecordSection.classList.add('hidden');
            addTabBtn.classList.add('active');
            viewTabBtn.classList.remove('active');
        });

        viewTabBtn.addEventListener('click', () => {
            viewRecordSection.classList.remove('hidden');
            addRecordSection.classList.add('hidden');
            viewTabBtn.classList.add('active');
            addTabBtn.classList.remove('active');
            // Refresh records when switching to this tab
            renderRecords(allRecords);
        });
        
        // --- Auto-focus for date inputs and other fields ---
        function setupAutoProgress() {
            const fields = [
                'firstName', 'lastName', 
                'investDateDay', 'investDateMonth', 'investDateYear',
                'dueDateDay', 'dueDateMonth', 'dueDateYear',
                'investSum', 'dueSum'
            ];
            fields.forEach((id, index) => {
                const el = document.getElementById(id);
                el.addEventListener('keyup', (e) => {
                    if ((el.maxLength > 0 && el.value.length === el.maxLength) || e.key === 'Enter') {
                        e.preventDefault();
                        const nextField = document.getElementById(fields[index + 1]);
                        if (nextField) nextField.focus();
                    }
                });
            });
        }
        setupAutoProgress();

        // --- Auto-set Due Date ---
        function setupAutoDueDate() {
            const ids = ['investDateDay', 'investDateMonth', 'investDateYear'];
            ids.forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const day = document.getElementById('investDateDay').value;
                    const month = document.getElementById('investDateMonth').value;
                    const year = document.getElementById('investDateYear').value;

                    if (day.length === 2 && month.length === 2 && year.length === 4) {
                        const investDate = new Date(`${year}-${month}-${day}`);
                        if (!isNaN(investDate.getTime())) {
                            investDate.setFullYear(investDate.getFullYear() + 1);
                            document.getElementById('dueDateDay').value = String(investDate.getDate()).padStart(2, '0');
                            document.getElementById('dueDateMonth').value = String(investDate.getMonth() + 1).padStart(2, '0');
                            document.getElementById('dueDateYear').value = investDate.getFullYear();
                        }
                    }
                });
            });
        }
        setupAutoDueDate();

        // --- Show Status Message ---
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 m-8 rounded-lg text-center text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => statusMessage.classList.add('hidden'), 4000);
        }

        // --- Add Record Form Submission ---
        addRecordForm.addEventListener('submit', e => {
            e.preventDefault();
            function getFormattedDate(dayId, monthId, yearId) {
                const day = document.getElementById(dayId).value.padStart(2, '0');
                const month = document.getElementById(monthId).value.padStart(2, '0');
                const year = document.getElementById(yearId).value;
                if (!day || !month || !year || year.length < 4) return null;
                return `${year}-${month}-${day}`;
            }

            const investDate = getFormattedDate('investDateDay', 'investDateMonth', 'investDateYear');
            const dueDate = getFormattedDate('dueDateDay', 'dueDateMonth', 'dueDateYear');
            if (!investDate || !dueDate) {
                showStatus('Please enter valid dates (DD/MM/YYYY).', true);
                return;
            }

            const button = e.target.querySelector('button');
            button.disabled = true;
            button.textContent = 'Saving...';

            const formData = {
                type: document.getElementById('type').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                investDate, dueDate,
                investSum: document.getElementById('investSum').value,
                dueSum: document.getElementById('dueSum').value,
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'addRecord', payload: formData, password: passwordInput.value })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('Record added successfully!');
                    addRecordForm.reset();
                    // Add new record to local list and refresh view
                    allRecords.unshift(data.data.newRecord);
                    clientNames = [...new Set(allRecords.map(r => `${r.FirstName} ${r.LastName}`))];
                } else { throw new Error(data.message); }
            })
            .catch(error => showStatus(`Error: ${error.message}`, true))
            .finally(() => { button.disabled = false; button.textContent = 'Save Record'; });
        });

        // --- Unlock App & Fetch Initial Data ---
        function unlockApp() {
            const password = passwordInput.value;
            if (!password) {
                showStatus('Please enter a password.', true);
                return;
            }
            
            const unlockButton = document.getElementById('unlockBtn');
            unlockButton.textContent = "Unlocking...";
            unlockButton.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getRecords', payload: { password } })
            })
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success') {
                    passwordWall.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    allRecords = response.data.reverse();
                    clientNames = [...new Set(allRecords.map(r => `${r.FirstName} ${r.LastName}`))];
                    setupAutocomplete(document.getElementById("firstName"), clientNames.map(n => n.split(' ')[0]));
                    setupAutocomplete(document.getElementById("lastName"), clientNames.map(n => n.split(' ')[1]));
                    
                    // *** FIX: Automatically switch to the view tab and render records ***
                    viewTabBtn.click();
                } else { throw new Error(response.message); }
            })
            .catch(error => {
                showStatus(`Error: ${error.message}`, true);
                unlockButton.textContent = "Unlock";
                unlockButton.disabled = false;
            });
        }
        unlockBtn.addEventListener('click', unlockApp);
        passwordInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') unlockApp(); });


        // --- Render Records ---
        function renderRecords(records) {
            recordList.innerHTML = '';
            if (records.length === 0) {
                recordList.innerHTML = '<p class="text-center text-gray-500">No records found.</p>';
                return;
            }
            records.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'p-4 border rounded-lg bg-gray-50';
                const investDate = record.InvestDate ? new Date(record.InvestDate).toLocaleDateString() : 'N/A';
                const dueDate = record.DueDate ? new Date(record.DueDate).toLocaleDateString() : 'N/A';
                recordDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">${record.FirstName} ${record.LastName}</h3>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${record.Type === 'Farm Investment' ? 'bg-green-200 text-green-800' : 'bg-blue-200 text-blue-800'}">${record.Type}</span>
                    </div>
                    <div class="mt-2 text-gray-600 grid grid-cols-2 gap-2 text-sm">
                        <p><strong>Invest Date:</strong> ${investDate}</p>
                        <p><strong>Due Date:</strong> ${dueDate}</p>
                        <p><strong>Invest Sum:</strong> ₦${record.InvestSum}</p>
                        <p><strong>Due Sum:</strong> ₦${record.DueSum}</p>
                        <p><strong>Renewals:</strong> ${record.TotalYears || 0}</p>
                    </div>`;
                recordList.appendChild(recordDiv);
            });
        }
        
        // --- Search and Sort Functionality ---
        function filterAndSortRecords() {
            let filtered = [...allRecords];
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(searchTerm)));
            }
            const sortBy = sortFilter.value;
            if (sortBy === 'asc') filtered.sort((a, b) => a.FirstName.localeCompare(b.FirstName));
            else if (sortBy === 'desc') filtered.sort((a, b) => b.FirstName.localeCompare(a.FirstName));
            renderRecords(filtered);
        }
        searchInput.addEventListener('input', filterAndSortRecords);
        sortFilter.addEventListener('change', filterAndSortRecords);

        // --- Autocomplete Function ---
        function setupAutocomplete(inp, arr) {
            let currentFocus;
            inp.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }
    </script>

</body>
</html>
